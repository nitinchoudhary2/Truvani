<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Truvani News</title>

    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #1a1a1a; color: white;
            margin: 0; padding: 20px;
        }
        h1, h2 { color: #00d4ff; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* NAYA: ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§∏‡•ç‡§ü‡•à‡§ü‡•ç‡§∏ (Stats) */
        .dashboard-stats {
            display: flex; gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #2a2a2a; padding: 20px;
            border-radius: 10px; border-left: 5px solid #00d4ff;
            flex-grow: 1;
        }
        .stat-card h3 { margin: 0; color: #aaa; font-size: 16px; }
        .stat-card .count { font-size: 32px; font-weight: bold; color: white; }

        .admin-form {
            background: #2a2a2a; padding: 25px;
            border-radius: 10px; border: 2px solid #00d4ff;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; margin-bottom: 8px;
            font-weight: bold; color: #00d4ff;
        }
        input, textarea, select {
            width: 100%; padding: 12px;
            border-radius: 5px; border: 1px solid #555;
            background: #333; color: white;
            font-size: 16px; box-sizing: border-box;
        }
        textarea { min-height: 150px; }
        button {
            background: #00d4ff; color: black;
            border: none; padding: 15px 30px;
            font-size: 16px; font-weight: bold;
            border-radius: 25px; cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { transform: scale(1.05); }
        #auth-status {
            font-size: 18px; text-align: center;
            padding: 40px; color: #ffc107;
        }
        #admin-content { display: none; }
        
        .news-list { margin-top: 30px; }
        .news-item {
            background: #2a2a2a; padding: 15px;
            border-radius: 8px; margin-bottom: 10px;
        }
        .news-item-header {
            display: flex; justify-content: space-between;
            align-items: center;
        }
        .news-item h3 { margin: 0; }
        
        /* NAYA: ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§ï‡•á ‡§Ü‡§Å‡§ï‡§°‡§º‡•á (Stats) */
        .news-item-stats {
            display: flex; gap: 20px;
            margin-top: 15px; padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 14px; color: #aaa;
        }

        .btn-action {
             padding: 10px 15px; border: none;
             border-radius: 15px; cursor: pointer;
             font-weight: bold; margin-left: 5px;
        }
        .edit-btn { background: #007bff; color: white; }
        .delete-btn { background: #e63946; color: white; }
        .cancel-btn { background: #6c757d; color: white; margin-left: 10px; }
        
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin Panel (Truvani News)</h1>
        
        <div id="auth-status">Loading... Checking authorization...</div>

        <div id="admin-content">
            
            <h2>Dashboard</h2>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Total Articles Posted</h3>
                    <div class="count" id="total-articles-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Views (All)</h3>
                    <div class="count" id="total-views-count">0</div>
                </div>
            </div>

            <form class="admin-form" id="news-form">
                <h2 id="form-title">Create New Article</h2>
                <input type="hidden" id="edit-mode-id">
                
                <div class="form-group">
                    <label for="title">Title (‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï)</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-group">
                    <label for="content">Content (‡§ñ‡§¨‡§∞)</label>
                    <textarea id="content" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="category">Category (‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä)</label>
                    <select id="category" required>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="National">National</option>
                        <option value="World">World</option>
                        <option value="Sports">Sports</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="image">Image File (‡§´‡§º‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç)</label>
                    <input type="file" id="image" accept="image/jpeg, image/png">
                </div>
                
                <div class="form-group">
                    <label for="imageUrl">OR Image Link (‡§Ø‡§æ ‡§´‡§º‡•ã‡§ü‡•ã ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç)</label>
                    <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg">
                </div>
                
                <button type="submit" id="submit-btn">Post Article</button>
                <button type="button" id="cancel-edit-btn" class="cancel-btn" style="display: none;" onclick="cancelEditMode()">Cancel Edit</button>
                <div id="loading" style="display: none; color: #00d4ff; margin-top: 15px;">Publishing...</div>
            </form>

            <div class="news-list">
                <h2>Existing Articles</h2>
                <div id="articles-list-container">Loading articles...</div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAeGWwKLkHB43i1FbedgkANPKcTCBh0Z9A",
            authDomain: "truvani-news-5ac15.firebaseapp.com",
            projectId: "truvani-news-5ac15",
            storageBucket: "truvani-news-5ac15.firebasestorage.app",
            messagingSenderId: "742142167141",
            appId: "1:742142167141:web:c2c116f5e50a574de85e8c"
        };
        
        // 2. Firebase ‡§ï‡•ã ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡§æ
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        const functions = firebase.functions();
        
        const authStatus = document.getElementById('auth-status');
        const adminContent = document.getElementById('admin-content');
        const newsForm = document.getElementById('news-form');
        const loading = document.getElementById('loading');
        const submitBtn = document.getElementById('submit-btn');
        const formTitle = document.getElementById('form-title');
        const editModeIdInput = document.getElementById('edit-mode-id');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        // 3. ‡§è‡§°‡§Æ‡§ø‡§® ‡§ö‡•á‡§ï (Lock System)
        auth.onAuthStateChanged(user => {
            if (user) {
                user.getIdTokenResult().then(idTokenResult => {
                    if (idTokenResult.claims.admin === true) {
                        authStatus.style.display = 'none';
                        adminContent.style.display = 'block';
                        
                        // NAYA: ‡§∏‡§æ‡§∞‡•á ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§Ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                        loadDashboardStats(); // ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§Ü‡§Å‡§ï‡§°‡§º‡•á
                        loadExistingArticles(); // ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü
                    } else {
                        authStatus.innerHTML = '<h2>Access Denied</h2>';
                    }
                });
            } else {
                authStatus.innerHTML = '<h2>Please Log In</h2>';
            }
        });
        
        // NAYA: 4. ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§Ü‡§Å‡§ï‡§°‡§º‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
        async function loadDashboardStats() {
            // ‡§ï‡•Å‡§≤ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ‡§â‡§Ç‡§ü
            try {
                const querySnapshot = await db.collection('news').get();
                document.getElementById('total-articles-count').textContent = querySnapshot.size;
                
                // ‡§ï‡•Å‡§≤ ‡§µ‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§ï‡§æ‡§â‡§Ç‡§ü (‡§Ø‡§π ‡§•‡•ã‡§°‡§º‡§æ ‡§ß‡•Ä‡§Æ‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§Ö‡§ó‡§∞ ‡§¨‡§π‡•Å‡§§ ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§π‡•à‡§Ç)
                let totalViews = 0;
                querySnapshot.forEach(doc => {
                    totalViews += (doc.data().views || 0);
                });
                document.getElementById('total-views-count').textContent = totalViews;

            } catch (e) { console.error("Stats Error: ", e); }
        }

        // 5. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§ü (‡§ï‡•ç‡§∞‡§ø‡§è‡§ü + ‡§è‡§°‡§ø‡§ü)
        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true; loading.style.display = 'block';

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const category = document.getElementById('category').value;
            const imageFile = document.getElementById('image').files[0];
            const imageUrlManual = document.getElementById('imageUrl').value; // NAYA
            
            const editId = editModeIdInput.value;
            let finalImageUrl = '';

            try {
                // NAYA: ‡§á‡§Æ‡•á‡§ú ‡§≤‡•â‡§ú‡§ø‡§ï (‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§æ ‡§Ö‡§™‡§≤‡•ã‡§°)
                if (imageUrlManual) {
                    // ‡§Ö‡§ó‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç
                    finalImageUrl = imageUrlManual;
                } else if (imageFile) {
                    // ‡§Ö‡§ó‡§∞ ‡§´‡§º‡§æ‡§á‡§≤ ‡§¶‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                    const imageRef = storage.ref(`news_images/${Date.now()}_${imageFile.name}`);
                    const snapshot = await imageRef.put(imageFile);
                    finalImageUrl = await snapshot.ref.getDownloadURL();
                }

                let articleData = {
                    title: title,
                    content: content,
                    category: category,
                    author: auth.currentUser.email,
                    timestamp: editId ? undefined : firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§®‡§à ‡§á‡§Æ‡•á‡§ú (‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§æ ‡§Ö‡§™‡§≤‡•ã‡§°) ‡§π‡•à, ‡§§‡§≠‡•Ä ‡§â‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                if (finalImageUrl) {
                    articleData.imageUrl = finalImageUrl;
                }

                articleData = JSON.parse(JSON.stringify(articleData)); // 'undefined' ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Å

                if (editId) {
                    // ‡§è‡§°‡§ø‡§ü ‡§Æ‡•ã‡§°
                    await db.collection('news').doc(editId).update(articleData);
                    alert('Article updated!');
                } else {
                    // ‡§ï‡•ç‡§∞‡§ø‡§è‡§ü ‡§Æ‡•ã‡§°
                    // NAYA: ‡§µ‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§î‡§∞ ‡§∞‡§ø‡§è‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ‡§ï‡•ã 0 ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
                    articleData.views = 0;
                    articleData.reactions = { "üëç": 0, "‚ù§Ô∏è": 0, "üî•": 0, "üòÆ": 0 };
                    await db.collection('news').add(articleData);
                    alert('Article published!');
                }

                cancelEditMode();
                loadExistingArticles();
                loadDashboardStats(); // NAYA: ‡§Ü‡§Å‡§ï‡§°‡§º‡•á ‡§∞‡•Ä‡§´‡§º‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç

            } catch (error) {
                alert('Failed to publish: ' + error.message);
            } finally {
                submitBtn.disabled = false; loading.style.display = 'none';
            }
        });

        // 6. ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ (NAYA: ‡§µ‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§î‡§∞ ‡§≤‡§æ‡§á‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§•)
        async function loadExistingArticles() {
            const container = document.getElementById('articles-list-container');
            container.innerHTML = 'Loading articles...';
            
            try {
                const snapshot = await db.collection('news').orderBy('timestamp', 'desc').limit(20).get();
                if (snapshot.empty) { container.innerHTML = 'No articles found.'; return; }
                
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // NAYA: ‡§∞‡§ø‡§è‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ (‡§≤‡§æ‡§á‡§ï‡•ç‡§∏) ‡§ï‡§æ ‡§ü‡•ã‡§ü‡§≤ ‡§ï‡§æ‡§â‡§Ç‡§ü
                    let totalReactions = 0;
                    if(data.reactions) {
                        totalReactions = Object.values(data.reactions).reduce((a, b) => a + b, 0);
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'news-item';
                    item.innerHTML = `
                        <div class="news-item-header">
                            <h3>${data.title} (${data.category})</h3>
                            <div>
                                <button class="btn-action edit-btn" onclick="loadArticleForEdit('${doc.id}')">Edit</button>
                                <button class="btn-action delete-btn" onclick="deleteArticle('${doc.id}')">Delete</button>
                            </div>
                        </div>
                        <div class="news-item-stats">
                            <span>üëÅÔ∏è Views: ${data.views || 0}</span>
                            <span>‚ù§Ô∏è Likes: ${totalReactions}</span>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                container.innerHTML = 'Failed to load articles.';
            }
        }

        // 7. ‡§è‡§°‡§ø‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
        async function loadArticleForEdit(docId) {
            const doc = await db.collection('news').doc(docId).get();
            if (!doc.exists) return;
            const data = doc.data();
            
            formTitle.textContent = 'Edit Article';
            document.getElementById('title').value = data.title;
            document.getElementById('content').value = data.content;
            document.getElementById('category').value = data.category;
            document.getElementById('imageUrl').value = data.imageUrl || ''; // NAYA
            editModeIdInput.value = docId;
            
            submitBtn.textContent = 'Update Article';
            cancelEditBtn.style.display = 'inline-block';
            window.scrollTo(0, 0);
        }
        
        // 8. ‡§è‡§°‡§ø‡§ü ‡§ï‡•à‡§Ç‡§∏‡§ø‡§≤ ‡§ï‡§∞‡§®‡§æ
        function cancelEditMode() {
            formTitle.textContent = 'Create New Article';
            newsForm.reset();
            editModeIdInput.value = '';
            submitBtn.textContent = 'Post Article';
            cancelEditBtn.style.display = 'none';
        }

        // 9. ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ
        async function deleteArticle(docId) {
            if (editModeIdInput.value === docId) { cancelEditMode(); }
            if (confirm('Are you sure you want to delete this article?')) {
                await db.collection('news').doc(docId).delete();
                alert('Article deleted.');
                loadExistingArticles();
                loadDashboardStats(); // NAYA: ‡§Ü‡§Å‡§ï‡§°‡§º‡•á ‡§∞‡•Ä‡§´‡§º‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
            }
        }
    </script>

</body>
</html>
