<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRUVANI Admin â€“ AI Console</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

  <!-- ====== CRITICAL CSS (inlined) ====== -->
  <style>
    :root{--p:#e63946;--s:#1a1a1a;--a:#00d4ff;--g:#28a745;--w:#ffc107;--like:#e91e63;--l:#fff;--d:#0a0a0a;--t:#333;--c:#f5f5f5;--b:#eee}
    body.dark-mode{--l:#1a1a1a;--d:#000;--t:#f0f0f0;--c:#222;--b:#333}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,sans-serif;background:var(--d);color:var(--t);line-height:1.6;overflow-x:hidden}
    a{color:var(--p);text-decoration:none}
    #login-container,#app-container{display:none;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:var(--l)}
    #login-form{background:var(--c);padding:32px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.1);width:100%;max-width:380px}
    .form-group{margin-bottom:16px}
    .form-label{font-weight:600;margin-bottom:6px;display:block}
    .form-input,.form-select,.ql-container{width:100%;padding:10px;background:var(--c);border:1px solid var(--b);border-radius:6px;color:var(--t);font-size:14px}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 3px rgba(230,57,70,.3)}
    .admin-btn{padding:11px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:.3s;width:100%;font-size:15px}
    .btn-primary{background:var(--p);color:#fff}
    .btn-primary:hover{background:#c72a38}
    .btn-ai{background:var(--a);color:#000;margin-top:8px}
    .btn-ai:disabled{background:#aaa;cursor:not-allowed}
    .btn-update{background:var(--g);color:#fff}
    .btn-cancel{background:var(--s);color:#fff;margin-top:8px}
    .admin-header{background:var(--l);border-bottom:3px solid var(--p);padding:16px 20px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .header-content{max-width:1400px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .admin-logo{font-size:26px;font-weight:900;color:var(--p)}
    .mode-toggle{cursor:pointer;font-size:18px;color:var(--t)}
    .admin-container{max-width:1400px;margin:30px auto;padding:0 16px}
    .admin-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:992px){.admin-grid{grid-template-columns:2fr 1fr}}
    .admin-panel{background:var(--l);border:1px solid var(--b);border-radius:12px;padding:24px}
    .panel-header{margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid var(--a)}
    .panel-title{font-size:20px;color:var(--a);font-weight:700}
    #article-list-container{max-height:600px;overflow-y:auto;border:1px solid var(--b);border-radius:8px}
    .article-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--b)}
    .article-item:last-child{border-bottom:none}
    .article-item-title{flex-grow:1;font-weight:600}
    .list-btn{padding:6px 10px;border:none;border-radius:5px;cursor:pointer;font-size:13px;color:#fff}
    .btn-edit{background:var(--w);color:#000}
    .btn-delete{background:var(--p)}
    #upload-progress-container{height:8px;background:var(--b);border-radius:4px;margin-top:8px;display:none;overflow:hidden}
    #upload-progress-bar{height:100%;background:var(--g);border-radius:4px;width:0;transition:width .3s}
    .image-preview-container{margin-top:12px;display:none}
    .image-preview-container img{max-height:180px;border-radius:8px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:16px}
    .stat-card{background:var(--c);padding:12px;border-radius:8px;text-align:center;font-size:14px}
    .stat-value{font-size:18px;font-weight:700;color:var(--a)}
    .skeleton{animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{background:#e0e0e0}50%{background:#f0f0f0}}
    #toastContainer{position:fixed;top:16px;right:16px;z-index:2000}
    .toast{background:rgba(0,0,0,.9);color:#fff;padding:12px 20px;border-radius:8px;margin-bottom:8px;min-width:280px;opacity:0;transform:translateX(100%);transition:.4s;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .toast.success{border-left:5px solid var(--g)}
    .toast.error{border-left:5px solid var(--p)}
    .toast.info{border-left:5px solid var(--a)}
    .toast-show{opacity:1;transform:translateX(0)}
    .search-input{margin-bottom:12px;padding:10px;border:1px solid var(--b);border-radius:6px;width:100%}
  </style>

  <!-- Preload Firebase -->
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js" as="script">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e63946">
</head>

<body>
  <!-- Toast -->
  <div id="toastContainer"></div>

  <!-- ====== LOGIN ====== -->
  <div id="login-container">
    <form id="login-form">
      <h2 style="text-align:center;color:var(--p);margin-bottom:16px">TRUVANI Admin</h2>
      <div id="login-error" style="color:var(--p);margin-bottom:12px;text-align:center"></div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="login-email" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="login-password" required>
      </div>
      <button type="submit" class="admin-btn btn-primary">Login</button>
    </form>
  </div>

  <!-- ====== APP ====== -->
  <div id="app-container">
    <  <header class="admin-header">
      <div class="header-content">
        <div>
          <div class="admin-logo">TRUVANI AI Console</div>
          <div style="font-size:12px;color:#666" id="admin-email">Welcome, ...</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <i class="fa-solid fa-moon mode-toggle" id="modeToggle" aria-label="Toggle dark mode"></i>
          <a href="index.html" style="color:var(--p);font-weight:600"><i class="fa-solid fa-arrow-left"></i> Site</a>
          <button id="logout-btn" style="background:none;border:none;color:var(--p);font-weight:600;cursor:pointer">
            <i class="fa-solid fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <div class="admin-container">
      <div class="admin-grid">
        <!-- Create/Edit Panel -->
        <div class="admin-panel">
          <div class="panel-header">
            <h2 class="panel-title" id="form-title"><i class="fae-solid fa-file-circle-plus"></i> CREATE ARTICLE</h2>
          </div>

          <form id="newsForm">
            <input type="hidden" id="edit-doc-id">
            <input type="hidden" id="old-image-url">

            <div class="form-group">
              <label class="form-label">Content (Rich Text)</label>
              <div id="editor" class="ql-container ql-snow" style="height:260px"></div>
            </div>

            <div class="form-group">
              <label class="form-label">Title</label>
              <input type="text" class="form-input" id="newsTitle" placeholder="AI can generate..." required>
              <button type="button" class="admin-btn btn-ai" id="generateTitleBtn">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Title
              </button>
            </div>

            <div class="form-group">
              <label class="form-label">Category</label>
              <select class="form-select" id="newsCategory" required>
                <option value="">Select</option>
                <option>Technology</option><option>Politics</option><option>Business</option>
                <option>Sports</option><option>Health</option><option>Entertainment</option>
                <option>World</option><option>Science</option><option>Lifestyle</option><option>Other</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Featured Image</label>
              <input type="file" class="form-input" id="imageFile" accept="image/*">
              <div id="upload-progress-container"><div id="upload-progress-bar"></div></div>
              <div class="image-preview-container" id="imagePreviewContainer">
                <img id="imagePreview" src="" alt="Preview">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Author</label>
              <input type="text" class="form-input" id="newsAuthor" value="Nitin Choudhary" required>
            </div>

            <div id="form-buttons" style="margin-top:20px">
              <button type="submit" class="admin-btn btn-primary" id="publishBtn">
                <i class="fa-solid fa-paper-plane"></i> PUBLISH
              </button>
            </div>
          </form>
        </div>

        <!-- Manage Panel -->
        <div class="admin-panel">
          <div class="panel-header">
            <h2 class="panel-title"><i class="fa-solid fa-list-check"></i> ARTICLES</h2>
          </div>

          <input type="text" class="search-input" id="articleSearch" placeholder="Search articles...">

          <div id="article-list-container">
            <!-- Skeleton -->
            <div class="article-item skeleton" style="height:50px">&nbsp;</div>
            <div class="article-item skeleton" style="height:50px">&nbsp;</div>
          </div>

          <div class="stats-grid">
            <div class="stat-card"><div>Total Articles</div><div class="stat-value" id="totalArticles">0</div></div>
            <div class="stat-card"><div>Total Views</div><div class="stat-value" id="totalViews">0</div></div>
            <div class="stat-card"><div>Total Likes</div><div class="stat-value" id="totalLikes">0</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== SCRIPTS ====== -->
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js";

    const app = initializeApp({
      apiKey: "AIzaSyAeGWwKLkHB43i1FbedgkANPKcTCBh0Z9A",
      authDomain: "truvani-news-5ac15.firebaseapp.com",
      projectId: "truvani-news-5ac15",
      storageBucket: "truvani-news-5ac15.firebasestorage.app",
      messagingSenderId: "742142167141",
      appId: "1:742142167141:web:c2c116f5e50a574de85e8c"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const GEMINI_KEY = "AIzaSyAeGWwKLkHB43i1FbedgkANPKcTCBh0Z9A";

    // ====== ELEMENTS ======
    const $ = s => document.querySelector(s);
    const loginForm = $('#login-form'), appContainer = $('#app-container'), loginContainer = $('#login-container');
    const newsForm = $('#newsForm'), quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: true } });
    const generateTitleBtn = $('#generateTitleBtn'), imageFile = $('#imageFile'), imagePreview = $('#imagePreviewContainer');

    let editId = '', oldImage = '', articlesUnsub = null;

    // ====== AUTH ======
    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const email = $('#login-email').value, pass = $('#login-password').value;
      signInWithEmailAndPassword(auth, email, pass).catch(err => {
        $('#login-error').textContent = err.message;
      });
    });

    $('#logout-btn').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, user => {
      if (user) {
        loginContainer.style.display = 'none';
        appContainer.style.display = 'block';
        $('#admin-email').textContent = `Welcome, ${user.email}`;
        loadArticles();
      } else {
        appContainer.style.display = 'none';
        loginContainer.style.display = 'flex';
      }
    });

    // ====== RICH TEXT TO PLAIN ======
    const getContent = () => quill.root.innerHTML;

    // ====== AI TITLE (debounced) ======
    let titleTimer;
    generateTitleBtn.addEventListener('click', () => {
      const text = quill.getText();
      if (text.length < 50) return showToast('Error', 'Write 50+ chars first', 'error');
      generateTitleBtn.disabled = true;
      generateTitleBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Thinking...';
      clearTimeout(titleTimer);
      titleTimer = setTimeout(async () => {
        try {
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: `Short catchy headline (max 10 words): ${text}` }] }] })
          });
          const json = await res.json();
          const title = json.candidates[0].content.parts[0].text.trim().replace(/["']/g, '');
          $('#newsTitle').value = title;
          showToast('AI', 'Title generated!', 'success');
        } catch (e) {
          showToast('Error', 'AI failed', 'error');
        }
        generateTitleBtn.disabled = false;
        generateTitleBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> AI Title';
      }, 600);
    });

    // ====== IMAGE PREVIEW & UPLOAD ======
    imageFile.addEventListener('change', () => {
      const file = imageFile.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          $('#imagePreview').src = e.target.result;
          imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        imagePreview.style.display = 'none';
      }
    });

    // ====== PUBLISH / UPDATE ======
    newsForm.addEventListener('submit', async e => {
      e.preventDefault();
      const isEdit = editId;
      const btn = $('#publishBtn');
      btn.disabled = true;
      btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${isEdit ? 'Updating' : 'Publishing'}...`;

      let imageUrl = oldImage;
      const file = imageFile.files[0];

      try {
        if (file) {
          $('#upload-progress-container').style.display = 'block';
          const storageRef = ref(storage, `articles/${Date.now()}-${file.name}`);
          const uploadTask = uploadBytesResumable(storageRef, file);
          await new Promise((res, rej) => {
            uploadTask.on('state_changed',
              snap => { $('#upload-progress-bar').style.width = (snap.bytesTransferred / snap.totalBytes * 100) + '%'; },
              rej, () => { getDownloadURL(uploadTask.snapshot.ref).then(url => { imageUrl = url; res(); }); }
            );
          });
          $('#upload-progress-container').style.display = 'none';
        }

        const data = {
          title: $('#newsTitle').value,
          content: getContent(),
          category: $('#newsCategory').value,
          imageUrl: imageUrl || 'https://via.placeholder.com/800x400.png?text=TRUVANI',
          author: $('#newsAuthor').value,
          date: new Date().toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' }),
          timestamp: serverTimestamp()
        };

        if (isEdit) {
          await updateDoc(doc(db, 'articles', editId), data);
          showToast('Success', 'Article updated!', 'success');
        } else {
          data.views = 0; data.likes = 0;
          await addDoc(collection(db, 'articles'), data);
          showToast('Success', 'Article published!', 'success');
        }
        resetForm();
      } catch (e) {
        showToast('Error', 'Save failed', 'error');
      }
      btn.disabled = false;
      btn.innerHTML = isEdit ? '<i class="fa-solid fa-save"></i> UPDATE' : '<i class="fa-solid fa-paper-plane"></i> PUBLISH';
    });

    // ====== LOAD ARTICLES ======
    function loadArticles() {
      const q = query(collection(db, 'articles'), orderBy('timestamp', 'desc'));
      articlesUnsub = onSnapshot(q, snap => {
        const container = $('#article-list-container');
        container.innerHTML = '';
        let totalViews = 0, totalLikes = 0;

        if (snap.empty) {
          container.innerHTML = '<p style="text-align:center;color:#888;padding:20px">No articles yet.</p>';
          updateStats(0, 0, 0);
          return;
        }

        snap.forEach(d => {
          const a = d.data(); const id = d.id;
          totalViews += a.views || 0; totalLikes += a.likes || 0;
          const div = document.createElement('div');
          div.className = 'article-item';
          div.innerHTML = `
            <div class="article-item-title">${a.title}</div>
            <div style="display:flex;gap:6px">
              <button class="list-btn btn-edit" onclick="editArticle('${id}')"><i class="fa-solid fa-pencil"></i></button>
              <button class="list-btn btn-delete" onclick="deleteArticle('${id}', '${a.title}')"><i class="fa-solid fa-trash-can"></i></button>
            </div>
          `;
          container.appendChild(div);
        });
        updateStats(snap.size, totalViews, totalLikes);
      });
    }

    function updateStats(articles, views, likes) {
      $('#totalArticles').textContent = articles;
      $('#totalViews').textContent = views;
      $('#totalLikes').textContent = likes;
    }

    // ====== EDIT ======
    window.editArticle = async id => {
      const docSnap = await doc(db, 'articles', id).get();
      if (!docSnap.exists()) return;
      const a = docSnap.data();
      editId = id; oldImage = a.imageUrl;

      $('#newsTitle').value = a.title;
      quill.root.innerHTML = a.content;
      $('#newsCategory').value = a.category;
      $('#newsAuthor').value = a.author;
      $('#edit-doc-id').value = id;
      $('#old-image-url').value = a.imageUrl;

      if (a.imageUrl && !a.imageUrl.includes('placeholder')) {
        $('#imagePreview').src = a.imageUrl;
        imagePreview.style.display = 'block';
      }

      $('#form-title').innerHTML = '<i class="fa-solid fa-pencil"></i> EDIT ARTICLE';
      $('#form-buttons').innerHTML = `
        <button type="submit" class="admin-btn btn-update"><i class="fa-solid fa-save"></i> UPDATE</button>
        <button type="button" class="admin-btn btn-cancel" onclick="resetForm()">CANCEL</button>
      `;
      window.scrollTo(0, 0);
    };

    // ====== DELETE ======
    window.deleteArticle = async (id, title) => {
      if (!confirm(`Delete "${title}"?`)) return;
      try {
        await deleteDoc(doc(db, 'articles', id));
        showToast('Deleted', 'Article removed', 'success');
      } catch (e) {
        showToast('Error', 'Delete failed', 'error');
      }
    };

    // ====== RESET FORM ======
    window.resetForm = () => {
      newsForm.reset();
      quill.setContents([]);
      $('#newsAuthor').value = 'Nitin Choudhary';
      editId = ''; oldImage = '';
      $('#edit-doc-id').value = '';
      $('#old-image-url').value = '';
      imagePreview.style.display = 'none';
      $('#form-title').innerHTML = '<i class="fa-solid fa-file-circle-plus"></i> CREATE ARTICLE';
      $('#form-buttons').innerHTML = `<button type="submit" class="admin-btn btn-primary"><i class="fa-solid fa-paper-plane"></i> PUBLISH</button>`;
    };

    // ====== SEARCH (client-side) ======
    $('#articleSearch').addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll('.article-item').forEach(item => {
        const title = item.querySelector('.article-item-title').textContent.toLowerCase();
        item.style.display = title.includes(term) ? 'flex' : 'none';
      });
    });

    // ====== TOAST ======
    function showToast(title, msg, type = 'info') {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div style="font-weight:600">${title}</div><div>${msg}</div>`;
      $('#toastContainer').appendChild(t);
      setTimeout(() => t.classList.add('toast-show'), 10);
      setTimeout(() => {
        t.classList.remove('toast-show');
        setTimeout(() => t.remove(), 500);
      }, 3500);
    }

    // ====== DARK MODE ======
    const modeToggle = $('#modeToggle');
    if (localStorage.getItem('adminDark') === '1') document.body.classList.add('dark-mode');
    modeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('adminDark', document.body.classList.contains('dark-mode') ? '1' : '0');
      modeToggle.classList.toggle('fa-moon'); modeToggle.classList.toggle('fa-sun');
    });

    // ====== SERVICE WORKER ======
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
