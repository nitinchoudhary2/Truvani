<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin - Truvani</title>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

  <style>
    body{font-family:system-ui;background:#0b0b0b;color:#fff;padding:20px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#111;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#0f0f0f;color:#fff;margin-top:8px}
    label{color:#bbb;font-weight:700}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .btn{background:#00d4ff;color:#000;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
    .danger{background:#e63946;color:#fff}
    .small{font-size:13px;color:#aaa}
    .list{margin-top:12px}
    .item{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#0c0c0c;margin-top:8px;border:1px solid #222}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin Panel â€” TRUVANI</h1>

    <div id="authSection" class="card" style="margin-bottom:16px">
      <div id="authForm">
        <label>Email</label>
        <input id="email" type="email" value="">
        <label>Password</label>
        <input id="password" type="password" value="">
        <div style="margin-top:12px">
          <button class="btn" onclick="doLogin()">Login</button>
        </div>
        <div class="small" style="margin-top:8px">Only admin can login.</div>
      </div>

      <div id="adminControls" style="display:none">
        <div class="small">Logged in as <span id="userEmail"></span> â€” <button onclick="doLogout()" class="small btn" style="background:#333;color:#fff">Logout</button></div>
      </div>
    </div>

    <div id="adminUI" style="display:none">
      <div class="card" style="margin-bottom:14px">
        <h3>Create / Edit Article</h3>
        <input id="editId" type="hidden">
        <label>Title</label><input id="title">
        <label>Content</label><textarea id="content" rows="6"></textarea>
        <div class="row">
          <div class="col">
            <label>Category</label>
            <select id="category">
              <option>Rajasthan</option>
              <option>National</option>
              <option>World</option>
              <option>Sports</option>
            </select>
          </div>
          <div class="col">
            <label>Image (File)</label>
            <input id="imageFile" type="file" accept="image/*">
            <label class="small">OR Image URL</label>
            <input id="imageUrl" placeholder="https://...">
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" onclick="publishArticle()">Publish</button>
          <button class="btn" onclick="updateArticle()" id="updateBtn" style="display:none">Update</button>
          <button class="danger" onclick="cancelEdit()" id="cancelBtn" style="display:none">Cancel</button>
        </div>
      </div>

      <div class="card">
        <h3>Existing Articles</h3>
        <div id="articlesList" class="list small">Loading...</div>
      </div>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAeGWwKLkHB43i1FbedgkANPKcTCBh0Z9A",
    authDomain: "truvani-news-5ac15.firebaseapp.com",
    projectId: "truvani-news-5ac15",
    storageBucket: "truvani-news-5ac15.firebasestorage.app",
    messagingSenderId: "742142167141",
    appId: "1:742142167141:web:c2c116f5e50a574de85e8c"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // --- admin email that is allowed to login (only client check)
  const ALLOWED_EMAIL = "nitinchoudharyw55@gmail.com";

  // Login (email/password)
  async function doLogin(){
    const email = document.getElementById('email').value.trim();
    const pw = document.getElementById('password').value;
    if(!email || !pw) return alert('Enter credentials');
    try{
      const res = await auth.signInWithEmailAndPassword(email,pw);
      // allow only ALLOWED_EMAIL
      if(res.user.email !== ALLOWED_EMAIL){
        await auth.signOut();
        return alert('Access denied (not admin email).');
      }
      onAuthChange(res.user);
    }catch(e){
      // If user not exist, show friendly message with next steps
      if(e.code === 'auth/user-not-found'){
        // Suggest creating the user from Firebase Console (safer)
        alert('User not found. Create this admin user in Firebase Console Authentication, then set it a secure password.');
      } else {
        alert('Login failed: ' + e.message);
      }
      console.error(e);
    }
  }

  function doLogout(){
    auth.signOut();
    document.getElementById('adminUI').style.display='none';
    document.getElementById('adminControls').style.display='none';
    document.getElementById('authForm').style.display='block';
  }

  auth.onAuthStateChanged(user=>{
    if(user && user.email===ALLOWED_EMAIL){
      onAuthChange(user);
    } else {
      // not logged in
    }
  });

  function onAuthChange(user){
    document.getElementById('authForm').style.display='none';
    document.getElementById('adminControls').style.display='block';
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('adminUI').style.display='block';
    loadArticlesAdmin();
  }

  // publish article
  async function publishArticle(){
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const category = document.getElementById('category').value;
    const file = document.getElementById('imageFile').files[0];
    const imageUrlManual = document.getElementById('imageUrl').value.trim();

    if(!title || !content) return alert('Title and content required');
    try{
      let imageUrl = '';
      if(imageUrlManual) imageUrl = imageUrlManual;
      else if(file){
        const ref = storage.ref('news_images/'+Date.now()+'_'+file.name);
        const snap = await ref.put(file);
        imageUrl = await snap.ref.getDownloadURL();
      }

      const doc = {
        title, content, category,
        author: auth.currentUser ? auth.currentUser.email : 'admin',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        imageUrl: imageUrl || '',
        views: 0,
        reactions: { "ðŸ‘":0,"â¤ï¸":0,"ðŸ”¥":0,"ðŸ˜®":0 }
      };

      await db.collection('news').add(doc);
      alert('Published');
      clearForm();
      loadArticlesAdmin();
    }catch(e){ console.error(e); alert('Publish failed: '+e.message) }
  }

  // load existing
  async function loadArticlesAdmin(){
    const list = document.getElementById('articlesList');
    list.innerHTML = 'Loading...';
    const snap = await db.collection('news').orderBy('timestamp','desc').get();
    if(snap.empty){ list.innerHTML = 'No articles'; return; }
    list.innerHTML = '';
    snap.forEach(doc=>{
      const d = doc.data();
      const id = doc.id;
      const title = d.title || '(no title)';
      const item = document.createElement('div');
      item.className='item';
      item.innerHTML = `<div>
        <div style="font-weight:800">${title}</div>
        <div class="small">${d.category||''} â€¢ ${ (d.timestamp && d.timestamp.toDate)? d.timestamp.toDate().toLocaleString() : '' }</div>
      </div>
      <div>
        <button class="btn" onclick="loadForEdit('${id}')">Edit</button>
        <button class="danger" onclick="deleteArticle('${id}')">Delete</button>
      </div>`;
      list.appendChild(item);
    });
  }

  async function loadForEdit(id){
    const doc = await db.collection('news').doc(id).get();
    if(!doc.exists) return alert('Not found');
    const d = doc.data();
    document.getElementById('editId').value = id;
    document.getElementById('title').value = d.title||'';
    document.getElementById('content').value = d.content||'';
    document.getElementById('category').value = d.category||'Rajasthan';
    document.getElementById('imageUrl').value = d.imageUrl||'';
    document.getElementById('updateBtn').style.display='inline-block';
    document.getElementById('cancelBtn').style.display='inline-block';
    document.getElementById('publishBtn')?.style?.display='none';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function updateArticle(){
    const id = document.getElementById('editId').value;
    if(!id) return alert('No edit id');
    try{
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const category = document.getElementById('category').value;
      const file = document.getElementById('imageFile').files[0];
      const imageUrlManual = document.getElementById('imageUrl').value.trim();

      let imageUrl = imageUrlManual;
      if(!imageUrl && file){
        const ref = storage.ref('news_images/'+Date.now()+'_'+file.name);
        const snap = await ref.put(file);
        imageUrl = await snap.ref.getDownloadURL();
      }

      const data = { title, content, category };
      if(imageUrl) data.imageUrl = imageUrl;

      await db.collection('news').doc(id).update(data);
      alert('Updated');
      clearForm();
      loadArticlesAdmin();
    }catch(e){ console.error(e); alert('Update failed: '+e.message) }
  }

  async function deleteArticle(id){
    if(!confirm('Delete?')) return;
    await db.collection('news').doc(id).delete();
    alert('Deleted');
    loadArticlesAdmin();
  }

  function cancelEdit(){
    clearForm();
  }
  function clearForm(){
    document.getElementById('editId').value='';
    document.getElementById('title').value='';
    document.getElementById('content').value='';
    document.getElementById('imageFile').value='';
    document.getElementById('imageUrl').value='';
    document.getElementById('updateBtn').style.display='none';
    document.getElementById('cancelBtn').style.display='none';
  }

  // Auto-suggest: when admin first time logs in, if user not created in auth, instruct admin
  // NOTE: Creating users with email/password programmatically requires admin SDK or console.
</script>
</body>
</html>
